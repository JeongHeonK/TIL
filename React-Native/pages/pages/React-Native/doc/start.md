React Native의 새로운 아키텍처(New Architecture)를 이해하기 위해서는 먼저 React Native에서 사용되는 몇 가지 용어와 이전 아키텍처의 용어를 이해해야 합니다. 아래에서 이 용어들을 먼저 살펴보겠습니다.

---

### 네이티브 모듈 (Native Modules)

"네이티브 모듈"은 Android의 경우 Java, iOS의 경우 Objective-C와 같은 네이티브 플랫폼 언어로 작성된 네이티브 코드 조각입니다. 이러한 네이티브 코드는 JavaScript에서 호출할 수 있습니다.

### 네이티브 모듈 시스템 (Native Module System)

네이티브 모듈 시스템은 JavaScript와 "네이티브 모듈"이 서로 통신할 수 있게 해주는 시스템입니다. 네이티브 모듈 시스템을 통해 JavaScript 코드는 카메라, 센서, 암호화 등 JavaScript에서 사용할 수 없는 네이티브 기능과 라이브러리를 사용할 수 있습니다.

React Native에는 두 가지 네이티브 모듈 시스템이 존재합니다:

1. OLD 네이티브 모듈 시스템

   일명 "브리지 기반 네이티브 모듈 시스템" 또는 "레거시 네이티브 모듈 시스템"이라 불리며, JSON 데이터를 직렬화하여 사용합니다.

2. New 네이티브 모듈 시스템

   일명 터보 모듈 시스템(Turbo Module System)으로, JSI(JavaScript Interface)를 사용합니다. JSI는 C++로 작성되었습니다.

### 타입이 지정된 JavaScript 코드 (Typed JavaScript code)

타입이 지정된 JavaScript 코드는 변수와 함수의 타입에 대한 추가 정보를 포함한 JavaScript 코드입니다. (Flow 또는 TypeScript를 사용하여 작성합니다.) 타입은 변수나 함수가 담을 수 있는 데이터의 종류를 나타내는 레이블입니다. 예를 들어, 타입은 숫자, 문자열, 불리언, 배열, 객체 또는 함수일 수 있습니다. 타입이 지정된 JavaScript 코드는 잘못된 타입 또는 누락된 타입으로 인한 오류와 버그를 방지하는 데 도움을 줍니다. 예를 들어, 숫자와 문자열을 더하려고 하면, 타입이 지정된 JavaScript 코드는 이 작업이 불가능하다는 경고를 제공합니다.

### 인터페이스 요소 (Interface Elements)

인터페이스 요소는 React Native 앱에서 사용할 수 있는 컴포넌트나 모듈입니다. 컴포넌트는 버튼, 텍스트, 이미지와 같은 사용자 인터페이스(UI)의 일부를 의미하며, 모듈은 카메라 접근, 센서, 암호화 라이브러리 등의 기능을 수행할 수 있는 코드 조각입니다. 인터페이스 요소는 "인터페이스"와 "구현"으로 나뉩니다. "인터페이스"는 해당 요소를 어떻게 사용할 수 있는지 정의하는 속성과 메서드의 집합이고, "구현"은 요소의 논리와 기능을 실제로 수행하는 코드입니다.

### OLD 아키텍처 (간단한 개요)

---

간단히 말해, 각 React Native 앱은 두 가지 주요 부분으로 구성됩니다:

1. JavaScript 코드
2. 네이티브 코드

코드는 세 가지 스레드에서 실행됩니다:

1. JavaScript 스레드: 특정 JavaScript 엔진을 사용하여 JS 번들을 실행합니다.
   네이티브/UI 스레드: 네이티브 코드를 실행하고 렌더링 또는 제스처 이벤트와 같은 UI 작업을 처리합니다.
2. Shadow 스레드: 레이아웃에서 네이티브 요소의 위치를 계산합니다.
3. JavaScript와 네이티브 스레드 간의 관계는 Bridge라는 구성 요소가 중재합니다.

### OLD 아키텍처의 단점

React Native 앱이 충분히 빠르긴 하지만, 성능 면에서 네이티브 솔루션보다는 뒤처지는 경향이 있습니다. 이는 사용된 아키텍처에 원인이 있습니다.

구 버전 아키텍처의 브리지(Bridge)는 JavaScript에서 네이티브로 전달해야 하는 모든 데이터를 직렬화하여 작동합니다.

브리지는 다음과 같은 몇 가지 제한이 있습니다:

- 비동기적: 한 레이어가 데이터를 브리지로 제출하고 다른 레이어에서 처리될 때까지 기다려야 합니다. 이때 불필요한 지연이 발생할 수 있습니다.
- 단일 스레드: JavaScript는 원래 단일 스레드였기 때문에 모든 연산이 하나의 스레드에서 수행되어야 합니다.
- 오버헤드 비용: 각 레이어가 서로 통신할 때마다 데이터를 직렬화해야 하고, 다른 레이어에서는 이를 역직렬화해야 합니다. JSON은 단순성과 가독성 덕분에 선택되었지만, 가볍다고 해도 이 과정에는 비용이 소요됩니다.

### React Native의 새로운 아키텍처 (간략 개요)

새로운 아키텍처는 브리지(Bridge) 개념을 JavaScript 인터페이스(JSI)로 대체하여 성능을 향상시켰습니다. 새로운 아키텍처는 React Native 0.68 버전부터 사용 가능합니다.

#### 새로운 아키텍처의 모든 구성 요소

새로운 아키텍처의 구성 요소는 다음과 같습니다.

- Codegen: 네이티브 코드 생성기
- JSI (JavaScript Interface): JavaScript와 네이티브 간 인터페이스
- Hermes 엔진: 기기에서 JS 코드를 실행하는 JS 엔진
- Turbo Module: JSI와 네이티브 코드를 사용하여 네이티브 모듈을 구현
- Fabric: 네이티브 UI 렌더러 (새로운 렌더 엔진)
- Fabric renderer: 새로운 렌더링 파이프라인 생성기
- Yoga: 플랫폼 간 레이아웃 엔진 (OLD 아키텍처에도 존재)

### 새로운 아키텍처의 두 단계

React Native의 새로운 아키텍처는 전체 사이클을 두 단계로 완료합니다.

- 1단계: 앱 빌드 시간
- 2단계: 앱 실행 시간

#### 1단계: 앱 빌드 시간

개발자가 Codegen과 Turbo Module을 활성화한 후, APK(Android) 또는 IPA(iOS) 생성 빌드 명령을 실행하면 다음 작업이 진행됩니다:

- 빌드 명령이 JavaScript 코드를 바이트 코드로 컴파일합니다.
- Codegen을 사용하여 빌드 시간에 네이티브 코드를 생성합니다.

생성된 바이트 코드와 네이티브 코드는 앱 패키지에 포함되어 기기에 설치됩니다.

> 중요: Codegen은 앱 빌드 시간에만 작동하며, 앱 실행 시간에는 작동하지 않습니다.

#### 2단계: 앱 실행 시간

사용자가 앱을 실행하면, React Native 앱의 새로운 아키텍처 흐름에 따라 나머지 작업이 수행됩니다. 주요 두 가지 구성 요소가 실행됩니다:

1. Turbo Module
2. Fabric

React Native의 새로운 아키텍처의 다른 하위 구성 요소들도 **“2단계: 앱 실행 시간”**에 실행됩니다. 이들은 아래와 같습니다:

- Hermes 엔진
- JSI (JavaScript Interface)
- 네이티브 모듈
- Yoga
- Fabric 렌더러

> 다시 기억하세요: Codegen은 이미 “1단계: 앱 빌드 시간”에 실행되었습니다.

### Codegen (네이티브 코드 생성기)

Codegen은 React Native의 새로운 아키텍처에서 두 가지 주요 역할을 합니다:

1. 정적 타입 검사
2. “네이티브 코드” 생성

#### 정적 타입 검사

- JavaScript는 동적 타입 언어(변수 타입을 정의할 필요가 없음)이고, JSI는 정적 타입 언어(변수 타입을 정의해야 함)인 C++로 작성되었습니다. 이 때문에 JavaScript와 C++ 간에 통신 문제가 발생할 수 있습니다.

- 이 문제를 해결하기 위해 새로운 아키텍처에는 Codegen이라는 정적 타입 검사기가 포함되었습니다. 이 검사기는 JavaScript와 C++ 간의 타입 관련 통신 문제를 해결해줍니다.

> 참고: Codegen은 JSI에 필요한 네이티브 코드를 준비할 뿐, JSI를 사용하지는 않습니다.

#### “네이티브 코드” 생성

Codegen은 새로운 아키텍처의 두 가지 주요 구성 요소에 필요한 네이티브 코드를 생성합니다. 이 두 가지 구성 요소는 다음과 같습니다:

1. Turbo Module
2. Fabric

두 구성 요소 모두 Codegen에서 생성된 네이티브 코드를 필요로 합니다.

Codegen이 네이티브 코드를 생성하는 과정은 다음과 같습니다:

- 사용자는 앱에서 사용할 네이티브 컴포넌트나 네이티브 모듈을 정의하기 위해 “타입이 지정된 JavaScript 코드”를 작성합니다.
- Codegen은 작성된 “타입이 지정된 JavaScript 코드”를 바탕으로 각 플랫폼에 맞는 “네이티브 코드”를 생성합니다.
- 생성된 “네이티브 코드”는 브리지를 사용하지 않고도 “타입이 지정된 JavaScript 코드”와 직접 통신할 수 있습니다. 이로 인해 JavaScript와 네이티브 코드 간의 통신이 더 빠르고 신뢰성 있게 이루어집니다.
- 중요: CodeGen은 실행 시간 대신 빌드 시간에 네이티브 코드를 생성합니다.

- Codegen을 사용하면 직접 “네이티브 코드”를 작성할 필요 없이 “타입이 지정된 JavaScript 코드”만 작성하여 컴포넌트나 모듈의 인터페이스를 정의하면 됩니다. Codegen이 나머지 작업을 처리해 줍니다.

- Codegen의 장점: 네이티브 모듈과 컴포넌트를 생성하고 유지 관리하는 데 필요한 작업량이 줄어듭니다.
